<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gacha Wheel App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#5D5CDE",
              secondary: "#4F4FC0",
            },
            animation: {
              "spin-slow": "spin 3s cubic-bezier(0.4, 0, 0.2, 1) forwards",
            },
          },
        },
      };
    </script>
    <style>
      .chest-container {
        position: relative;
        width: 300px;
        height: 280px;
        margin: 0 auto;
        perspective: 600px;
      }

      .chest {
        width: 100%;
        height: 100%;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.5s ease-in-out;
      }

      .chest.opening {
        transform: rotateX(-70deg);
      }

      .chest-base {
        width: 100%;
        height: 70%;
        background-color: #8b4513; /* Brown for wooden chest */
        position: absolute;
        bottom: 0;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        border: 4px solid #5d3a1a;
        box-sizing: border-box;
        background-image: linear-gradient(
          to right,
          rgba(93, 58, 26, 0.5) 0px,
          rgba(93, 58, 26, 0.5) 10px,
          transparent 10px,
          transparent 20px
        );
        background-size: 100px 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chest-lid {
        width: 110%;
        height: 40%;
        background-color: #8b4513;
        position: absolute;
        top: 0;
        left: -5%;
        border-radius: 10px 10px 0 0;
        transform-origin: bottom center;
        border: 4px solid #5d3a1a;
        box-sizing: border-box;
        background-image: linear-gradient(
          to right,
          rgba(93, 58, 26, 0.5) 0px,
          rgba(93, 58, 26, 0.5) 10px,
          transparent 10px,
          transparent 20px
        );
        background-size: 100px 100%;
      }

      .chest-lock {
        width: 40px;
        height: 30px;
        background-color: #daa520; /* Gold */
        border-radius: 5px;
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 2px solid #b8860b;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }

      .chest-glow {
        position: absolute;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 0;
        height: 0;
        background: radial-gradient(
          circle,
          rgba(255, 223, 0, 0.8) 0%,
          rgba(255, 255, 255, 0) 70%
        );
        border-radius: 50%;
        opacity: 0;
        transition: all 0.5s ease-in-out;
      }

      .chest.opening .chest-glow {
        width: 200px;
        height: 200px;
        opacity: 1;
      }

      .chest-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
        padding: 12px 24px;
        background-color: #5d5cde;
        color: white;
        border: none;
        border-radius: 999px;
        font-weight: bold;
        font-size: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .chest-button:hover {
        transform: translate(-50%, -50%) scale(1.05);
        background-color: #4f4fc0;
      }

      .chest-button:disabled {
        background-color: #9e9ddd;
        cursor: not-allowed;
        opacity: 0.7;
      }

      .dark .chest-base,
      .dark .chest-lid {
        background-color: #6d3511;
        border-color: #4a2512;
      }

      .dark .chest-lock {
        background-color: #b8860b;
        border-color: #886108;
      }

      /* Result Panel Floating Styles */
      #resultContainer {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 50;
        animation: float-in 0.5s ease-out;
        max-width: 90vw;
      }

      @keyframes float-in {
        0% {
          opacity: 0;
          transform: translate(-50%, -30%);
        }
        100% {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
      }

      /* Overlay for the floating panel */
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 40;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      /* Additional color palette for wheel segments */
      .color-1 {
        background-color: #ff7979;
      }
      .color-2 {
        background-color: #ffce79;
      }
      .color-3 {
        background-color: #ffe779;
      }
      .color-4 {
        background-color: #bdff79;
      }
      .color-5 {
        background-color: #79ffb3;
      }
      .color-6 {
        background-color: #79ffec;
      }
      .color-7 {
        background-color: #79c8ff;
      }
      .color-8 {
        background-color: #7986ff;
      }
      .color-9 {
        background-color: #b679ff;
      }
      .color-10 {
        background-color: #ff79dc;
      }

      .dark .color-1 {
        background-color: #c45656;
      }
      .dark .color-2 {
        background-color: #c49856;
      }
      .dark .color-3 {
        background-color: #c4b456;
      }
      .dark .color-4 {
        background-color: #8dc456;
      }
      .dark .color-5 {
        background-color: #56c487;
      }
      .dark .color-6 {
        background-color: #56c4b8;
      }
      .dark .color-7 {
        background-color: #5698c4;
      }
      .dark .color-8 {
        background-color: #5664c4;
      }
      .dark .color-9 {
        background-color: #8a56c4;
      }
      .dark .color-10 {
        background-color: #c456a9;
      }
    </style>
  </head>
  <body
    class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen"
  >
    <!-- Overlay for floating panel -->
    <div id="resultOverlay" class="overlay"></div>

    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold text-center mb-8">Treasure Chest Gacha</h1>

      <!-- Tabs -->
      <div class="flex justify-center mb-8">
        <button
          id="gachaTab"
          class="px-4 py-2 border-b-2 border-primary font-medium text-primary"
        >
          Treasure Chest
        </button>
        <button
          id="collectionTab"
          class="px-4 py-2 border-b-2 border-transparent font-medium text-gray-500 dark:text-gray-400"
        >
          Collection
        </button>
      </div>

      <!-- Gacha Section -->
      <div id="gachaSection" class="space-y-8">
        <!-- Chest Section -->
        <div class="chest-container">
          <div class="chest" id="chest">
            <div class="chest-lid"></div>
            <div class="chest-lock"></div>
            <div class="chest-base"></div>
            <div class="chest-glow"></div>
            <button id="openButton" class="chest-button">Open (10)</button>
          </div>
        </div>
      </div>

      <!-- Collection Section -->
      <div id="collectionSection" class="hidden space-y-8">
        <h2 class="text-2xl font-bold text-center">Your Collection</h2>

        <!-- Filter/Sort Controls -->
        <div class="flex flex-wrap gap-3 justify-center">
          <div>
            <label class="text-sm font-medium mb-1 block">Sort by:</label>
            <select
              id="sortCollection"
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-base"
            >
              <option value="name">Name</option>
              <option value="count">Amount</option>
              <option value="recent">Recently Added</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium mb-1 block">Order:</label>
            <select
              id="sortOrder"
              class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-base"
            >
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>

        <!-- Collection Grid -->
        <div
          id="collectionGrid"
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
        >
          <!-- Collection items will be added here dynamically -->
          <div
            class="text-center text-gray-500 dark:text-gray-400 col-span-full py-8"
          >
            Your collection is empty. Spin the wheel to win items!
          </div>
        </div>
      </div>
    </div>

    <!-- Result Display (Floating) -->
    <div id="resultContainer" class="hidden">
      <div
        class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden border border-primary"
      >
        <div class="p-5">
          <h3 class="text-xl font-bold mb-2 text-center" id="resultTitle">
            You got: <span id="resultItemName"></span>
          </h3>
          <div
            id="resultImageContainer"
            class="flex justify-center mb-4 h-40 items-center"
          >
            <div
              id="resultNoImage"
              class="w-32 h-32 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center"
            >
              <span class="text-4xl">üéÅ</span>
            </div>
            <img
              id="resultImage"
              class="max-h-40 max-w-full object-contain hidden"
              src=""
              alt=""
            />
          </div>
          <p
            class="text-gray-600 dark:text-gray-300 text-center"
            id="resultDescription"
          ></p>
        </div>
        <div
          class="bg-gray-100 dark:bg-gray-700 px-5 py-3 flex justify-center items-center gap-3"
        >
          <button
            id="addToCollectionBtn"
            class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded text-sm font-medium"
          >
            Add to Collection
          </button>
          <button
            id="skipCollectionBtn"
            class="px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white rounded text-sm font-medium"
          >
            Skip
          </button>
        </div>
      </div>
    </div>

    <script>
      // Dark mode detection
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      ) {
        document.documentElement.classList.add("dark");
      }
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (event) => {
          if (event.matches) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        });

      // Function to send spend points request to parent window and await for the response
      function sendSpendPointsRequestToParent(points, source) {
        return new Promise((resolve, reject) => {
          function handleResponse(event) {
            if (event.data && event.data.type === "pointsDeductResponse") {
              window.removeEventListener("message", handleResponse);
              resolve(event.data);
            }
          }

          window.addEventListener("message", handleResponse);

          window.parent.postMessage(
            {
              type: "pointsDeduct",
              points: points,
              source: source,
            },
            "*"
          );
        });
      }

      // Global variables
      let chestItems = [];
      let currentResult = null;
      let collection = [];
      const DEFAULT_CHEST_COST = 10; // Set default cost to 10

      // DOM elements
      const chest = document.getElementById("chest");
      const openButton = document.getElementById("openButton");
      const resultContainer = document.getElementById("resultContainer");
      const resultOverlay = document.getElementById("resultOverlay");
      const resultItemName = document.getElementById("resultItemName");
      const resultDescription = document.getElementById("resultDescription");
      const resultImage = document.getElementById("resultImage");
      const resultNoImage = document.getElementById("resultNoImage");
      const addToCollectionBtn = document.getElementById("addToCollectionBtn");
      const skipCollectionBtn = document.getElementById("skipCollectionBtn");
      const collectionGrid = document.getElementById("collectionGrid");
      const gachaTab = document.getElementById("gachaTab");
      const collectionTab = document.getElementById("collectionTab");
      const gachaSection = document.getElementById("gachaSection");
      const collectionSection = document.getElementById("collectionSection");
      const sortCollection = document.getElementById("sortCollection");
      const sortOrder = document.getElementById("sortOrder");

      // Load chest items
      function loadChestItems(items) {
        // Validate that rates sum to 100
        const totalRate = items.reduce(
          (sum, item) => sum + item.itemRateInWheel,
          0
        );
        if (Math.abs(totalRate - 100) > 0.01) {
          throw new Error(
            `Invalid JSON: Item rates should sum to 100, but got ${totalRate}`
          );
        }

        // Store the items
        chestItems = items;

        // Update the open button with current cost

        updateOpenButtonCost();
      }

      // Update open button cost

      function updateOpenButtonCost() {
        openButton.textContent = `Open (${DEFAULT_CHEST_COST})`;
      }

      // Show the result panel
      function showResultPanel() {
        resultContainer.classList.remove("hidden");
        resultOverlay.classList.add("active");
      }

      // Hide the result panel
      function hideResultPanel() {
        resultContainer.classList.add("hidden");
        resultOverlay.classList.remove("active");
      }

      // Open the chest
      async function openChest() {
        if (chestItems.length === 0) {
          alert("Please load chest items first");
          return;
        }

        // Send points deduct request with fixed cost of 10
        const { isSuccessful } = await sendSpendPointsRequestToParent(
          DEFAULT_CHEST_COST,
          "Gacha Chest Open"
        );

        if (!isSuccessful) {
          console.log("User does not have enough point to gatcha");
          return;
        }

        // Disable open button
        openButton.disabled = true;
        openButton.classList.add("opacity-50");

        // Add opening animation to chest
        chest.classList.add("opening");

        // Generate random result based on item rates
        const random = Math.random() * 100;
        let cumulativeRate = 0;
        let selectedItem = null;

        for (const item of chestItems) {
          cumulativeRate += item.itemRateInWheel;
          if (random <= cumulativeRate) {
            selectedItem = item;
            break;
          }
        }

        if (!selectedItem) {
          selectedItem = chestItems[chestItems.length - 1];
        }

        // Show result after animation
        setTimeout(() => {
          currentResult = selectedItem;

          // Display result
          resultItemName.textContent = selectedItem.itemName;
          resultDescription.textContent = selectedItem.itemDescription;

          // Handle image if present
          if (selectedItem.itemImage) {
            resultImage.src = selectedItem.itemImage;
            resultImage.classList.remove("hidden");
            resultNoImage.classList.add("hidden");
          } else {
            resultImage.classList.add("hidden");
            resultNoImage.classList.remove("hidden");
          }

          // Show result panel with option to add to collection
          showResultPanel();

          // Close the chest and re-enable button after 2s
          setTimeout(() => {
            chest.classList.remove("opening");
            openButton.disabled = false;
            openButton.classList.remove("opacity-50");
          }, 1000);
        }, 1500);
      }

      // Add item to collection
      function addToCollection(item) {
        // Check if item is already in collection
        const existingItemIndex = collection.findIndex(
          (collectionItem) => collectionItem.itemName === item.itemName
        );

        if (existingItemIndex !== -1) {
          // Increment count
          collection[existingItemIndex].count += 1;
          // Update timestamp
          collection[existingItemIndex].lastAdded = Date.now();
        } else {
          // Add new item to collection
          collection.push({
            ...item,
            count: 1,
            lastAdded: Date.now(),
          });
        }

        // Save to localStorage if available
        try {
          localStorage.setItem("gachaCollection", JSON.stringify(collection));
        } catch (e) {
          console.log("Could not save to localStorage:", e);
        }

        // Update collection display if visible
        if (collectionSection.classList.contains("hidden") === false) {
          renderCollection();
        }
      }

      // Load collection from localStorage
      function loadCollection() {
        try {
          const savedCollection = localStorage.getItem("gachaCollection");
          if (savedCollection) {
            collection = JSON.parse(savedCollection);
          }
        } catch (e) {
          console.log("Could not load from localStorage:", e);
        }
      }

      // Render collection items
      function renderCollection() {
        // Apply sorting
        const sortType = sortCollection.value;
        const order = sortOrder.value === "asc" ? 1 : -1;

        let sortedCollection = [...collection];

        if (sortType === "name") {
          sortedCollection.sort(
            (a, b) => a.itemName.localeCompare(b.itemName) * order
          );
        } else if (sortType === "count") {
          sortedCollection.sort((a, b) => (a.count - b.count) * order);
        } else if (sortType === "recent") {
          sortedCollection.sort((a, b) => (a.lastAdded - b.lastAdded) * order);
        }

        // Clear grid
        collectionGrid.innerHTML = "";

        // Display empty message if needed
        if (sortedCollection.length === 0) {
          const emptyMessage = document.createElement("div");
          emptyMessage.className =
            "text-center text-gray-500 dark:text-gray-400 col-span-full py-8";
          emptyMessage.textContent =
            "Your collection is empty. Open treasure chests to win items!";
          collectionGrid.appendChild(emptyMessage);
          return;
        }

        // Add items
        sortedCollection.forEach((item) => {
          const itemElement = document.createElement("div");
          itemElement.className =
            "bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden";

          let imageHTML = `
                    <div class="h-32 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                        <span class="text-4xl">üéÅ</span>
                    </div>
                `;

          if (item.itemImage) {
            imageHTML = `
                        <div class="h-32 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                            <img src="${item.itemImage}" alt="${item.itemName}" class="max-h-32 max-w-full object-contain">
                        </div>
                    `;
          }

          itemElement.innerHTML = `
                    ${imageHTML}
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-1">${item.itemName}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${item.itemDescription}</p>
                        <div class="flex items-center justify-between">
                            <span class="bg-primary/10 text-primary dark:bg-primary/20 px-2 py-1 rounded text-sm">
                                √ó${item.count}
                            </span>
                        </div>
                    </div>
                `;

          collectionGrid.appendChild(itemElement);
        });
      }

      // Pre-load items' images
      function preloadItemImages(items) {
        items.forEach((item) => {
          const img = new Image();
          img.src = item.itemImage;
        });
      }

      // Initialize app
      document.addEventListener("DOMContentLoaded", async () => {
        // Initialize chest with default items from default file
        const response = await fetch("gatcha-items.json");
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const items = await response.json();
        loadChestItems(items);
        preloadItemImages(items);

        // Load collection from localStorage
        loadCollection();

        // Set up event listeners
        openButton.addEventListener("click", openChest);

        // Add to collection button
        addToCollectionBtn.addEventListener("click", () => {
          if (currentResult) {
            addToCollection(currentResult);

            // Show confirmation toast
            const toastContainer = document.createElement("div");
            toastContainer.className =
              "fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50";
            toastContainer.textContent = "Added to collection!";
            document.body.appendChild(toastContainer);

            // Remove toast after 2 seconds
            setTimeout(() => {
              toastContainer.remove();
            }, 2000);
          }
          hideResultPanel();
        });

        // Skip adding to collection
        skipCollectionBtn.addEventListener("click", hideResultPanel);

        // Close result panel when overlay is clicked
        resultOverlay.addEventListener("click", hideResultPanel);

        // Tab functionality
        gachaTab.addEventListener("click", () => {
          gachaTab.classList.add("border-primary", "text-primary");
          gachaTab.classList.remove(
            "border-transparent",
            "text-gray-500",
            "dark:text-gray-400"
          );

          collectionTab.classList.remove("border-primary", "text-primary");
          collectionTab.classList.add(
            "border-transparent",
            "text-gray-500",
            "dark:text-gray-400"
          );

          gachaSection.classList.remove("hidden");
          collectionSection.classList.add("hidden");
        });

        collectionTab.addEventListener("click", () => {
          collectionTab.classList.add("border-primary", "text-primary");
          collectionTab.classList.remove(
            "border-transparent",
            "text-gray-500",
            "dark:text-gray-400"
          );

          gachaTab.classList.remove("border-primary", "text-primary");
          gachaTab.classList.add(
            "border-transparent",
            "text-gray-500",
            "dark:text-gray-400"
          );

          collectionSection.classList.remove("hidden");
          gachaSection.classList.add("hidden");

          renderCollection();
        });

        // Collection sorting
        sortCollection.addEventListener("change", renderCollection);
        sortOrder.addEventListener("change", renderCollection);
      });
    </script>
  </body>
</html>
