<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pomodoro Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#5D5CDE",
              secondary: "#F87171",
              success: "#10B981",
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="font-sans bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-200"
  >
    <!-- Check for dark mode -->
    <script>
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      ) {
        document.documentElement.classList.add("dark");
      }
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (event) => {
          if (event.matches) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        });
    </script>

    <div class="min-h-screen p-4 flex flex-col items-center justify-center">
      <div
        class="w-full max-w-md bg-gray-100 dark:bg-gray-800 rounded-xl shadow-lg p-4"
      >
        <h1 class="text-2xl font-bold mb-3 text-center text-primary">
          Pomodoro Timer
        </h1>

        <div class="flex flex-col md:flex-row gap-4">
          <!-- Timer Display (smaller size) -->
          <div class="flex-1">
            <div class="relative">
              <div class="w-48 h-48 mx-auto relative">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                  <circle
                    class="text-gray-300 dark:text-gray-700"
                    stroke-width="4"
                    stroke="currentColor"
                    fill="transparent"
                    r="45"
                    cx="50"
                    cy="50"
                  />
                  <circle
                    id="progress-circle"
                    class="text-primary"
                    stroke-width="4"
                    stroke="currentColor"
                    fill="transparent"
                    r="45"
                    cx="50"
                    cy="50"
                    stroke-dasharray="283"
                    stroke-dashoffset="0"
                    transform="rotate(-90 50 50)"
                  />
                </svg>
                <div
                  class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center"
                >
                  <div id="timer" class="text-4xl font-bold">25:00</div>
                  <div id="session-type" class="text-lg mt-1">Work Session</div>
                </div>
              </div>
            </div>

            <!-- Controls -->
            <div class="flex justify-center space-x-4 mt-2">
              <button
                id="start-pause"
                class="bg-primary hover:bg-opacity-90 text-white rounded-lg py-1.5 px-4 font-semibold transition-colors"
              >
                Start
              </button>
              <button
                id="reset"
                class="bg-gray-400 dark:bg-gray-600 hover:bg-opacity-90 text-white rounded-lg py-1.5 px-4 font-semibold transition-colors"
              >
                Reset
              </button>
            </div>
          </div>

          <!-- Right side with settings and stats -->
          <div class="flex-1 flex flex-col justify-between">
            <!-- Timer Count -->
            <div class="flex justify-around text-center mb-3">
              <div>
                <div
                  class="text-xs uppercase tracking-wide text-gray-600 dark:text-gray-400"
                >
                  Sessions
                </div>
                <div id="session-count" class="text-xl font-semibold">0</div>
              </div>
              <div>
                <div
                  class="text-xs uppercase tracking-wide text-gray-600 dark:text-gray-400"
                >
                  Total Focus
                </div>
                <div id="total-focus" class="text-xl font-semibold">0m</div>
              </div>
            </div>

            <!-- Settings -->
            <div class="bg-white dark:bg-gray-700 rounded-lg p-3">
              <h3 class="text-sm font-semibold mb-2">Settings</h3>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label
                    for="work-time"
                    class="block text-xs text-gray-600 dark:text-gray-400"
                    >Work (min)</label
                  >
                  <input
                    id="work-time"
                    type="number"
                    min="1"
                    max="60"
                    value="25"
                    class="w-full rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-800 py-1 px-2 text-sm"
                  />
                </div>
                <div>
                  <label
                    for="break-time"
                    class="block text-xs text-gray-600 dark:text-gray-400"
                    >Break (min)</label
                  >
                  <input
                    id="break-time"
                    type="number"
                    min="1"
                    max="30"
                    value="5"
                    class="w-full rounded-md border border-gray-300 dark:border-gray-600 dark:bg-gray-800 py-1 px-2 text-sm"
                  />
                </div>
              </div>
            </div>

            <!-- Info text -->
            <div class="text-xs text-gray-600 dark:text-gray-400 mt-2">
              Work in timed intervals followed by short breaks to maintain
              focus.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // DOM Elements
        const timerEl = document.getElementById("timer");
        const sessionTypeEl = document.getElementById("session-type");
        const startPauseBtn = document.getElementById("start-pause");
        const resetBtn = document.getElementById("reset");
        const sessionCountEl = document.getElementById("session-count");
        const totalFocusEl = document.getElementById("total-focus");
        const workTimeInput = document.getElementById("work-time");
        const breakTimeInput = document.getElementById("break-time");
        const progressCircle = document.getElementById("progress-circle");

        // Timer variables
        let timeLeft = workTimeInput.value * 60;
        let totalTimeForMode = timeLeft;
        let timerInterval = null;
        let isRunning = false;
        let isWorkMode = true;
        let sessionCount = 0;
        let totalFocusMinutes = 0;

        // Circle progress calculations
        const FULL_DASH_ARRAY = 283;

        // Audio feedback (using AudioContext)
        let audioContext;

        // Function to send points to parent window
        function sendPointsToParent(points, source) {
          if (window.parent) {
            window.parent.postMessage(
              {
                type: "pointsUpdate",
                points: points,
                source: source,
              },
              "*"
            );
          }
        }

        // Initialize audio context on user interaction
        function initAudio() {
          if (!audioContext) {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          }
        }

        // Play notification sound
        function playNotification() {
          if (!audioContext) return;

          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.type = "sine";
          oscillator.frequency.value = isWorkMode ? 800 : 600;
          gainNode.gain.value = 0.1;

          oscillator.start();

          // Duration of beep
          setTimeout(() => {
            oscillator.stop();
          }, 500);
        }

        // Format time as mm:ss
        function formatTime(seconds) {
          const mins = Math.floor(seconds / 60)
            .toString()
            .padStart(2, "0");
          const secs = (seconds % 60).toString().padStart(2, "0");
          return `${mins}:${secs}`;
        }

        // Update the timer display
        function updateTimer() {
          timerEl.textContent = formatTime(timeLeft);

          // Update progress circle
          const dashOffset =
            FULL_DASH_ARRAY * (1 - timeLeft / totalTimeForMode);
          progressCircle.style.strokeDashoffset = dashOffset;
        }

        // Switch between work and break modes
        function switchMode() {
          isWorkMode = !isWorkMode;

          if (isWorkMode) {
            sessionTypeEl.textContent = "Work Session";
            sessionTypeEl.classList.remove("text-success");
            sessionTypeEl.classList.add("text-primary");
            progressCircle.classList.remove("text-success");
            progressCircle.classList.add("text-primary");
            timeLeft = workTimeInput.value * 60;
          } else {
            sessionTypeEl.textContent = "Break Time";
            sessionTypeEl.classList.remove("text-primary");
            sessionTypeEl.classList.add("text-success");
            progressCircle.classList.remove("text-primary");
            progressCircle.classList.add("text-success");
            timeLeft = breakTimeInput.value * 60;

            // Increment session count after completing a work session
            sessionCount++;
            sessionCountEl.textContent = sessionCount;

            // Add to total focus time
            const workTime = parseInt(workTimeInput.value);
            totalFocusMinutes += workTime;
            totalFocusEl.textContent = `${totalFocusMinutes}m`;

            // Award points for completing a work session (10 points per session)
            const pointsEarned = workTime * 2; // 2 points per minute of work
            sendPointsToParent(pointsEarned, "Pomodoro Completed");
          }

          totalTimeForMode = timeLeft;
          updateTimer();
        }

        // Timer logic
        function startTimer() {
          timerInterval = setInterval(() => {
            timeLeft--;
            updateTimer();

            if (timeLeft <= 0) {
              playNotification();
              clearInterval(timerInterval);
              switchMode();

              // Auto-start next session
              if (isRunning) {
                startTimer();
              }
            }
          }, 1000);
        }

        // Event handlers
        startPauseBtn.addEventListener("click", () => {
          initAudio();

          if (isRunning) {
            // Pause timer
            clearInterval(timerInterval);
            startPauseBtn.textContent = "Resume";
          } else {
            // Start/resume timer
            startTimer();
            startPauseBtn.textContent = "Pause";
          }

          isRunning = !isRunning;
        });

        resetBtn.addEventListener("click", () => {
          // Stop timer
          clearInterval(timerInterval);
          isRunning = false;
          startPauseBtn.textContent = "Start";

          // Reset to work mode
          isWorkMode = true;
          sessionTypeEl.textContent = "Work Session";
          sessionTypeEl.classList.remove("text-success");
          sessionTypeEl.classList.add("text-primary");
          progressCircle.classList.remove("text-success");
          progressCircle.classList.add("text-primary");

          // Reset time
          timeLeft = workTimeInput.value * 60;
          totalTimeForMode = timeLeft;
          updateTimer();
        });

        // Handle settings changes
        workTimeInput.addEventListener("change", () => {
          if (isWorkMode && !isRunning) {
            timeLeft = workTimeInput.value * 60;
            totalTimeForMode = timeLeft;
            updateTimer();
          }
        });

        breakTimeInput.addEventListener("change", () => {
          if (!isWorkMode && !isRunning) {
            timeLeft = breakTimeInput.value * 60;
            totalTimeForMode = timeLeft;
            updateTimer();
          }
        });

        // Initialize
        updateTimer();
      });
    </script>
  </body>
</html>
